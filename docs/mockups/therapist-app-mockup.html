<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Therapist App Mockup</title>
<style>
  :root {
    /* Brand */
    --brand:#007e8c;         /* primary */
    --brand-2:#8358A2;       /* secondary */
    --brand-ink:#001a23;
    /* UI */
    --bg:#0b1220; --card:#0f172a; --muted:#9aa8be; --text:#e5e7eb;
    --warn:#f59e0b; --danger:#ef4444; --border:#1f2937; --chip:#132237; --chip-text:#9adff0;
  }
  html,body { margin:0; padding:0; background:#0b1220; color:var(--text); font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; }
  .app { display:flex; min-height:100dvh; flex-direction:column; }
  header { position:sticky; top:0; z-index:20; background:linear-gradient(180deg,#0b1220,rgba(11,18,32,0.7)); backdrop-filter:saturate(120%) blur(6px);
           border-bottom:1px solid var(--border); }
  .header-inner { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; }
  .brand { display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.3px; }
  .brand .logo { width:28px; height:28px; border-radius:8px; background:linear-gradient(135deg,var(--brand),var(--brand-2)); box-shadow:0 0 0 2px #062a35 inset; }
  .chip { padding:4px 8px; border-radius:999px; background:var(--chip); color:var(--chip-text); font-size:12px; border:1px solid #243244; }
  main { flex:1; display:flex; flex-direction:column; padding:12px; gap:12px; }
  .hidden { display:none !important; }
  .cards { display:grid; gap:12px; grid-template-columns:1fr 1fr; }
  .card { background:linear-gradient(180deg,var(--card),#0b1220); border:1px solid var(--border); border-radius:14px; padding:12px; }
  .card h3 { margin:0 0 8px; font-size:14px; color:#c7d2fe; font-weight:600; }
  .stat { font-size:22px; font-weight:800; }
  .muted { color:var(--muted); font-size:12px; }
  .list { display:flex; flex-direction:column; gap:10px; }
  .item { background:linear-gradient(180deg,var(--card),#0b1220); border:1px solid var(--border); border-radius:14px; padding:12px; display:flex; gap:12px; align-items:flex-start; }
  .badge { font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid #2a394d; }
  .success { color:#86efac; background:#052e16; border-color:#14532d; }
  .warning { color:#fde68a; background:#422006; border-color:#713f12; }
  .danger { color:#fecaca; background:#450a0a; border-color:#7f1d1d; }
  .btn { all:unset; display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:12px; font-weight:600; cursor:pointer; }
  .btn-primary { background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:var(--brand-ink); }
  .btn-ghost { color:#bfefff; border:1px solid #0f3b44; background:#072930; }
  .btn-danger { background:linear-gradient(135deg,#ef4444,#b91c1c); color:#fff; }
  .btn-outline { border:1px solid var(--border); color:#e2e8f0; background:transparent; }
  .grid { display:grid; gap:10px; }
  .grid-2 { grid-template-columns:1fr 1fr; }
  .field { display:flex; flex-direction:column; gap:6px; }
  .label { font-size:12px; color:#94a3b8; }
  .input, select, textarea, input[type=datetime-local], input[type=date], input[type=time], input[type=number], input[type=text] {
    padding:10px 12px; border-radius:10px; border:1px solid #263446; background:#0b1524; color:#e5e7eb; outline:none;
  }
  .section-title { margin:4px 0; color:#c7d2fe; font-weight:700; }
  nav { position:sticky; bottom:0; background:linear-gradient(0deg,#0b1220,rgba(11,18,32,0.7)); border-top:1px solid var(--border); }
  .tabs { display:flex; overflow-x:auto; scrollbar-width:none; -ms-overflow-style:none; }
  .tabs::-webkit-scrollbar { display:none; }
  .tab { flex:0 0 auto; min-width:92px; padding:12px 8px; text-align:center; color:#a3a3a3; font-size:12px; font-weight:600; cursor:pointer; }
  .tab.active { color:#86efac; border-top:2px solid var(--brand); }
  .modal-backdrop { position:fixed; inset:0; background:rgba(2,6,23,0.7); backdrop-filter:blur(4px); display:none; align-items:flex-end; }
  .modal { width:100%; background:#0b1220; border-top:1px solid var(--border); border-radius:14px 14px 0 0; padding:14px; }
  .modal h3 { margin:0 0 10px; }
  .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
  @media(min-width:900px){ main{ padding:18px; gap:16px; } .cards{ grid-template-columns:repeat(4,1fr);} .grid-2{ grid-template-columns:repeat(3,1fr);} .modal{ width:480px; margin:0 auto 24px; border-radius:16px;} .modal-backdrop{ align-items:center; justify-content:center;} }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="header-inner">
      <div class="brand"><div class="logo"></div> Therapist App <span class="chip">Mobile-first</span></div>
      <div class="chip">Wed Payouts</div>
    </div>
  </header>

  <main>
    <section id="screen-dashboard">
      <div class="cards">
        <div class="card">
          <h3>Next Payout (Est.)</h3>
          <div class="stat">$682.50</div>
          <div class="muted">Week: Mon–Sun</div>
        </div>
        <div class="card">
          <h3>Jobs Today</h3>
          <div class="stat">2</div>
          <div class="muted">10:00, 14:30</div>
        </div>
        <div class="card">
          <h3>Tips (Week)</h3>
          <div class="stat">$45.00</div>
          <div class="muted">Informational</div>
        </div>
        <div class="card">
          <h3>Expenses Pending</h3>
          <div class="stat">1</div>
          <div class="muted">Parking review</div>
        </div>
      </div>

      <h3 class="section-title">Upcoming</h3>
      <div class="list">
        <div class="item">
          <div style="flex:1">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <strong>Corporate Wellness – CBD</strong>
              <span class="badge warning">Today 10:00</span>
            </div>
            <div class="muted">2h · 1 therapist · Booking #RMM-1042</div>
          </div>
          <button class="btn btn-ghost" onclick="goTab('bookings')">View</button>
        </div>
      </div>
    </section>

    <section id="screen-bookings" class="hidden">
      <div class="list">
        <div class="item">
          <div style="flex:1">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <strong>Hotel Spa – Southbank</strong>
              <span class="badge success">Assigned</span>
            </div>
            <div class="muted">Sun, 10:00–12:00 · 2h · Fee: $120.00</div>
          </div>
          <button class="btn btn-outline" onclick="openBooking()">Open</button>
        </div>

        <div class="item">
          <div style="flex:1">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <strong>Office – Docklands</strong>
              <span class="badge">Upcoming</span>
            </div>
            <div class="muted">Tue, 14:30–16:00 · 1.5h · Fee: $90.00</div>
          </div>
          <button class="btn btn-outline" onclick="openBooking()">Open</button>
        </div>
      </div>
    </section>

    <section id="screen-booking-detail" class="hidden">
      <div class="card">
        <h3>Booking #RMM-1042</h3>
        <div class="muted">Corporate Wellness – 10:00–12:00 · 2h</div>
        <div class="muted">Address: 123 Collins St, CBD</div>
      </div>

      <div class="grid grid-2">
        <button class="btn btn-primary" onclick="markCompleted()">Mark Completed</button>
        <button class="btn btn-danger" onclick="markCancelled()">Cancel with Note</button>
      </div>

      <div class="grid grid-2">
        <button class="btn btn-ghost" onclick="openModal('modal-tip')">Add Tip</button>
        <button class="btn btn-ghost" onclick="openModal('modal-expense')">Add Parking Expense</button>
      </div>

      <div class="card">
        <h3>Notes</h3>
        <textarea rows="4" class="input" placeholder="Optional booking notes..."></textarea>
      </div>
    </section>

    <section id="screen-exceptions" class="hidden">
      <div class="card">
        <h3>Add Availability Exception</h3>
        <div class="grid">
          <div class="field">
            <label class="label">Type</label>
            <select class="input">
              <option value="available">Available (override)</option>
              <option value="unavailable">Unavailable (block)</option>
            </select>
          </div>
          <div class="grid grid-2">
            <div class="field">
              <label class="label">Start</label>
              <input type="datetime-local" class="input" />
            </div>
            <div class="field">
              <label class="label">End</label>
              <input type="datetime-local" class="input" />
            </div>
          </div>
          <div class="field">
            <label class="label">Reason (optional)</label>
            <input type="text" class="input" placeholder="e.g., Special event window" />
          </div>
          <div style="display:flex; gap:8px; justify-content:flex-end;">
            <button class="btn btn-outline" onclick="toast('Discarded')">Discard</button>
            <button class="btn btn-primary" onclick="toast('Exception saved')">Save Exception</button>
          </div>
        </div>
      </div>

      <h3 class="section-title">Upcoming Exceptions</h3>
      <div class="list">
        <div class="item">
          <div style="flex:1">
            <strong>Available</strong> <span class="muted">Sun 10:00–16:00</span>
          </div>
          <button class="btn btn-outline" onclick="toast('Deleted')">Delete</button>
        </div>
      </div>
    </section>

    <section id="screen-earnings" class="hidden">
      <div class="card">
        <h3>Weekly Summary (Mon–Sun)</h3>
        <div class="grid grid-2">
          <div>
            <div class="muted">Jobs</div>
            <div class="stat">6</div>
          </div>
          <div>
            <div class="muted">Gross Fees</div>
            <div class="stat">$720.00</div>
          </div>
          <div>
            <div class="muted">Approved Expenses</div>
            <div class="stat">$12.50</div>
          </div>
          <div>
            <div class="muted">Final Payable</div>
            <div class="stat">$732.50</div>
          </div>
        </div>
      </div>

      <h3 class="section-title">Items</h3>
      <div class="list">
        <div class="item">
          <div style="flex:1">
            <strong>Completed Job</strong>
            <div class="muted">Sun – 2h · Fee $120.00</div>
          </div>
          <span class="badge success">Booking</span>
        </div>
        <div class="item">
          <div style="flex:1">
            <strong>Parking Expense</strong>
            <div class="muted">Receipt #IMG_2033 · $12.50</div>
          </div>
          <span class="badge">Expense</span>
        </div>
      </div>

      <h3 class="section-title">History</h3>
      <div class="list">
        <div class="item">
          <div style="flex:1">
            <strong>Paid</strong>
            <div class="muted">Week ending Sun · $705.00 · EFT REF 8492</div>
          </div>
          <span class="badge success">Paid</span>
        </div>
      </div>
    </section>
  </main>

  <!-- Calendar (stub) -->
  <section id="screen-calendar" class="hidden" style="padding:12px;">
    <div class="card">
      <h3>Calendar</h3>
      <div class="muted">Month/Week/Day views (stub). Overlay bookings, time off, exceptions.</div>
      <div style="height:240px; margin-top:8px; border:1px dashed var(--border); border-radius:12px;"></div>
    </div>
  </section>

  <!-- Profile -->
  <section id="screen-profile" class="hidden" style="padding:12px;">
    <div class="card">
      <h3>Personal Info</h3>
      <div class="grid">
        <div class="grid grid-2">
          <div class="field"><label class="label">First Name</label><input class="input" placeholder="First" /></div>
          <div class="field"><label class="label">Last Name</label><input class="input" placeholder="Last" /></div>
        </div>
        <div class="field"><label class="label">Email</label><input class="input" placeholder="email@domain.com" /></div>
        <div class="field"><label class="label">Phone</label><input class="input" placeholder="+61 ..." /></div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
        <button class="btn btn-outline">Cancel</button>
        <button class="btn btn-primary">Save</button>
      </div>
    </div>
  </section>

  <!-- Service Area (polygon stub) -->
  <section id="screen-service-area" class="hidden" style="padding:12px;">
    <div class="card">
      <h3>Service Area</h3>
      <div class="muted">Draw/edit polygon on map.</div>
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
      <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
      <div id="map" style="height:300px; margin-top:8px; border:1px solid var(--border); border-radius:12px; background:#071422;"></div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
        <button class="btn btn-outline" onclick="resetPolygon()">Reset</button>
        <button class="btn btn-primary" onclick="savePolygon()">Save Area</button>
      </div>
    </div>
  </section>

  <!-- Availability (base weekly schedule) -->
  <section id="screen-availability" class="hidden" style="padding:12px;">
    <div class="card">
      <h3>Weekly Availability</h3>
      <div class="grid">
        <div class="grid grid-2">
          <div class="field"><label class="label">Mon</label><input type="time" class="input" value="09:00" /> – <input type="time" class="input" value="17:00" /></div>
          <div class="field"><label class="label">Tue</label><input type="time" class="input" value="09:00" /> – <input type="time" class="input" value="17:00" /></div>
          <div class="field"><label class="label">Wed</label><input type="time" class="input" value="09:00" /> – <input type="time" class="input" value="17:00" /></div>
          <div class="field"><label class="label">Thu</label><input type="time" class="input" value="09:00" /> – <input type="time" class="input" value="17:00" /></div>
          <div class="field"><label class="label">Fri</label><input type="time" class="input" value="09:00" /> – <input type="time" class="input" value="17:00" /></div>
          <div class="field"><label class="label">Sat</label><input type="time" class="input" value="" placeholder="Off" /> – <input type="time" class="input" value="" placeholder="Off" /></div>
          <div class="field"><label class="label">Sun</label><input type="time" class="input" value="" placeholder="Off" /> – <input type="time" class="input" value="" placeholder="Off" /></div>
        </div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
        <button class="btn btn-outline">Cancel</button>
        <button class="btn btn-primary">Save Availability</button>
      </div>
    </div>
  </section>

  <!-- Time Off -->
  <section id="screen-time-off" class="hidden" style="padding:12px;">
    <div class="card">
      <h3>Time Off</h3>
      <div class="grid grid-2">
        <div class="field"><label class="label">Start</label><input type="datetime-local" class="input" /></div>
        <div class="field"><label class="label">End</label><input type="datetime-local" class="input" /></div>
      </div>
      <div class="field"><label class="label">Reason</label><input class="input" placeholder="Optional" /></div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
        <button class="btn btn-outline">Cancel</button>
        <button class="btn btn-primary">Add Time Off</button>
      </div>
    </div>
    <h3 class="section-title">Upcoming Time Off</h3>
    <div class="list">
      <div class="item"><div style="flex:1"><strong>Fri 12 Apr</strong> <span class="muted">09:00–13:00</span></div><button class="btn btn-outline">Delete</button></div>
    </div>
  </section>

  <!-- Services -->
  <section id="screen-services" class="hidden" style="padding:12px;">
    <div class="card">
      <h3>Services</h3>
      <div class="list">
        <div class="item"><div style="flex:1"><strong>Chair Massage</strong><div class="muted">30/60 mins</div></div><label><input type="checkbox" checked /> Offer</label></div>
        <div class="item"><div style="flex:1"><strong>Table Massage</strong><div class="muted">60/90 mins</div></div><label><input type="checkbox" /> Offer</label></div>
        <div class="item"><div style="flex:1"><strong>Sports Recovery</strong><div class="muted">30/60 mins</div></div><label><input type="checkbox" /> Offer</label></div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
        <button class="btn btn-primary">Save Services</button>
      </div>
    </div>
  </section>

  <nav>
    <div class="tabs">
      <div class="tab active" data-tab="dashboard" onclick="goTab('dashboard')">Dashboard</div>
      <div class="tab" data-tab="bookings" onclick="goTab('bookings')">Bookings</div>
      <div class="tab" data-tab="calendar" onclick="goTab('calendar')">Calendar</div>
      <div class="tab" data-tab="profile" onclick="goTab('profile')">Profile</div>
      <div class="tab" data-tab="service-area" onclick="goTab('service-area')">Service Area</div>
      <div class="tab" data-tab="availability" onclick="goTab('availability')">Availability</div>
      <div class="tab" data-tab="time-off" onclick="goTab('time-off')">Time Off</div>
      <div class="tab" data-tab="services" onclick="goTab('services')">Services</div>
      <div class="tab" data-tab="exceptions" onclick="goTab('exceptions')">Exceptions</div>
      <div class="tab" data-tab="earnings" onclick="goTab('earnings')">Earnings</div>
    </div>
  </nav>
</div>

<div id="modal-tip" class="modal-backdrop">
  <div class="modal">
    <h3>Add Tip</h3>
    <div class="grid">
      <div class="field">
        <label class="label">Amount</label>
        <input type="number" class="input" placeholder="0.00" />
      </div>
      <div class="field">
        <label class="label">Method</label>
        <select class="input">
          <option value="cash">Cash</option>
          <option value="card">Card</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="field">
        <label class="label">Notes</label>
        <input class="input" placeholder="Optional" />
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('modal-tip')">Cancel</button>
      <button class="btn btn-primary" onclick="saveTip()">Save</button>
    </div>
  </div>
  </div>

<div id="modal-expense" class="modal-backdrop">
  <div class="modal">
    <h3>Add Parking Expense</h3>
    <div class="grid">
      <div class="grid grid-2">
        <div class="field">
          <label class="label">Amount</label>
          <input type="number" class="input" placeholder="0.00" />
        </div>
        <div class="field">
          <label class="label">Type</label>
          <select class="input">
            <option value="parking">Parking</option>
            <option value="toll">Toll</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>
      <div class="field">
        <label class="label">Receipt (URL)</label>
        <input type="text" class="input" placeholder="https://..." />
      </div>
      <div class="field">
        <label class="label">Notes</label>
        <input class="input" placeholder="Optional" />
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('modal-expense')">Cancel</button>
      <button class="btn btn-primary" onclick="saveExpense()">Submit</button>
    </div>
  </div>
</div>

<script>
  const screens = ['dashboard','bookings','booking-detail','calendar','profile','service-area','availability','time-off','services','exceptions','earnings'];
  function goTab(tab){
    document.querySelectorAll('.tab').forEach(el => el.classList.toggle('active', el.dataset.tab===tab));
    screens.forEach(id => {
      const sec = document.getElementById('screen-'+id);
      if (!sec) return;
      if (id === tab) sec.classList.remove('hidden'); else sec.classList.add('hidden');
    });
    document.getElementById('screen-booking-detail').classList.add('hidden');
  }
  function openBooking(){
    screens.forEach(id => { const sec = document.getElementById('screen-'+id); if (sec) sec.classList.add('hidden'); });
    document.getElementById('screen-booking-detail').classList.remove('hidden');
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    document.querySelector('.tab[data-tab="bookings"]').classList.add('active');
  }
  function openModal(id){ document.getElementById(id).style.display='flex'; }
  function closeModal(id){ document.getElementById(id).style.display='none'; }
  function toast(msg){ console.log(msg); }

  // Working actions
  function markBookingCompleted(bookingId) {
    const booking = state.bookings.find(b => b.id === bookingId);
    if (booking) {
      booking.status = 'completed';
      saveState();
      refreshUI();
      toast('Booking marked as completed');
    }
  }

  function markBookingCancelled(bookingId, notes) {
    const booking = state.bookings.find(b => b.id === bookingId);
    if (booking) {
      booking.status = 'cancelled';
      booking.notes = notes || booking.notes;
      saveState();
      refreshUI();
      toast('Booking cancelled');
    }
  }

  function addTip(bookingId, amount, method, notes) {
    const tip = {
      id: 'tip_' + Date.now(),
      bookingId,
      amount: parseFloat(amount),
      method,
      notes,
      date: new Date().toISOString().split('T')[0]
    };
    state.tips.push(tip);
    saveState();
    refreshUI();
    toast('Tip added');
  }

  function addExpense(amount, type, receipt, notes) {
    const expense = {
      id: 'exp_' + Date.now(),
      amount: parseFloat(amount),
      type,
      receipt,
      notes,
      date: new Date().toISOString().split('T')[0],
      approved: false
    };
    state.expenses.push(expense);
    saveState();
    refreshUI();
    toast('Expense submitted for approval');
  }

  function addException(type, start, end, reason) {
    const exception = {
      id: 'exc_' + Date.now(),
      type,
      start,
      end,
      reason
    };
    state.exceptions.push(exception);
    saveState();
    refreshUI();
    toast('Exception added');
  }

  function addTimeOff(start, end, reason) {
    const timeOff = {
      id: 'to_' + Date.now(),
      start,
      end,
      reason
    };
    state.timeOff.push(timeOff);
    saveState();
    refreshUI();
    toast('Time off added');
  }

  function toggleService(serviceId) {
    const service = state.services.find(s => s.id === serviceId);
    if (service) {
      service.enabled = !service.enabled;
      saveState();
      refreshUI();
    }
  }

  function refreshUI() {
    // Refresh dashboard stats
    const earnings = getWeeklyEarnings();
    const dashboardStats = document.querySelectorAll('#screen-dashboard .stat');
    if (dashboardStats[0]) dashboardStats[0].textContent = '$' + earnings.finalPayable.toFixed(2);
    
    // Refresh bookings list
    const bookingsContainer = document.querySelector('#screen-bookings .list');
    if (bookingsContainer) {
      bookingsContainer.innerHTML = state.bookings.map(booking => `
        <div class="item">
          <div style="flex:1">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <strong>${booking.title}</strong>
              <span class="badge ${booking.status === 'completed' ? 'success' : booking.status === 'cancelled' ? 'danger' : 'warning'}">${booking.status}</span>
            </div>
            <div class="muted">${new Date(booking.date).toLocaleDateString()}, ${booking.time} · ${booking.duration}h · Fee: $${booking.fee.toFixed(2)}</div>
          </div>
          <button class="btn btn-outline" onclick="openBooking('${booking.id}')">Open</button>
        </div>
      `).join('');
    }

    // Refresh earnings
    const earningsContainer = document.querySelector('#screen-earnings .card .grid');
    if (earningsContainer) {
      earningsContainer.innerHTML = `
        <div><div class="muted">Jobs</div><div class="stat">${earnings.jobs}</div></div>
        <div><div class="muted">Gross Fees</div><div class="stat">$${earnings.grossFees.toFixed(2)}</div></div>
        <div><div class="muted">Approved Expenses</div><div class="stat">$${earnings.approvedExpenses.toFixed(2)}</div></div>
        <div><div class="muted">Tips</div><div class="stat">$${earnings.tips.toFixed(2)}</div></div>
        <div><div class="muted">Final Payable</div><div class="stat">$${earnings.finalPayable.toFixed(2)}</div></div>
      `;
    }
  }

  // --- Local state with localStorage persistence ---
  const STORAGE_KEY_POLY = 'therapist_service_area_geojson';
  const STORAGE_KEY_DATA = 'therapist_app_data';
  let map, drawControl, drawnLayer;

  // In-memory state
  let state = {
    bookings: [
      { id: 'RMM-1042', title: 'Corporate Wellness – CBD', date: '2025-01-27', time: '10:00', duration: 2, fee: 120, status: 'assigned', notes: '' },
      { id: 'RMM-1043', title: 'Hotel Spa – Southbank', date: '2025-01-26', time: '10:00', duration: 2, fee: 120, status: 'completed', notes: 'Great client' },
      { id: 'RMM-1044', title: 'Office – Docklands', date: '2025-01-28', time: '14:30', duration: 1.5, fee: 90, status: 'assigned', notes: '' }
    ],
    tips: [
      { id: 'tip1', bookingId: 'RMM-1043', amount: 45, method: 'cash', notes: 'Very happy client', date: '2025-01-26' }
    ],
    expenses: [
      { id: 'exp1', amount: 12.5, type: 'parking', receipt: 'IMG_2033.jpg', notes: 'CBD parking', date: '2025-01-26', approved: true }
    ],
    exceptions: [
      { id: 'exc1', type: 'available', start: '2025-01-26T10:00:00', end: '2025-01-26T16:00:00', reason: 'Special event window' }
    ],
    timeOff: [
      { id: 'to1', start: '2025-04-12T09:00:00', end: '2025-04-12T13:00:00', reason: 'Personal appointment' }
    ],
    services: [
      { id: 'svc1', name: 'Chair Massage', duration: '30/60 mins', enabled: true },
      { id: 'svc2', name: 'Table Massage', duration: '60/90 mins', enabled: false },
      { id: 'svc3', name: 'Sports Recovery', duration: '30/60 mins', enabled: false }
    ],
    availability: {
      mon: { start: '09:00', end: '17:00' },
      tue: { start: '09:00', end: '17:00' },
      wed: { start: '09:00', end: '17:00' },
      thu: { start: '09:00', end: '17:00' },
      fri: { start: '09:00', end: '17:00' },
      sat: { start: '', end: '' },
      sun: { start: '', end: '' }
    }
  };

  function loadState() {
    const saved = localStorage.getItem(STORAGE_KEY_DATA);
    if (saved) {
      try {
        state = { ...state, ...JSON.parse(saved) };
      } catch {}
    }
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(state));
  }

  function getWeeklyEarnings() {
    const now = new Date();
    const startOfWeek = new Date(now);
    startOfWeek.setDate(now.getDate() - now.getDay() + 1); // Monday
    startOfWeek.setHours(0, 0, 0, 0);
    
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6); // Sunday
    endOfWeek.setHours(23, 59, 59, 999);

    const completedJobs = state.bookings.filter(b => 
      b.status === 'completed' && 
      new Date(b.date) >= startOfWeek && 
      new Date(b.date) <= endOfWeek
    );

    const approvedExpenses = state.expenses.filter(e => 
      e.approved && 
      new Date(e.date) >= startOfWeek && 
      new Date(e.date) <= endOfWeek
    );

    const grossFees = completedJobs.reduce((sum, job) => sum + job.fee, 0);
    const approvedExpenseTotal = approvedExpenses.reduce((sum, exp) => sum + exp.amount, 0);
    const tips = state.tips.filter(t => 
      new Date(t.date) >= startOfWeek && 
      new Date(t.date) <= endOfWeek
    ).reduce((sum, tip) => sum + tip.amount, 0);

    return {
      jobs: completedJobs.length,
      grossFees,
      approvedExpenses: approvedExpenseTotal,
      tips,
      finalPayable: grossFees + approvedExpenseTotal + tips,
      completedJobs,
      approvedExpenses,
      tipsList: state.tips.filter(t => 
        new Date(t.date) >= startOfWeek && 
        new Date(t.date) <= endOfWeek
      )
    };
  }

  function initMap(){
    if (map) return;
    const L_css = document.querySelector('link[href*="leaflet.css"]');
    if (!L_css) return; // only on service-area screen
    const scriptLeaflet = document.createElement('script');
    scriptLeaflet.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    scriptLeaflet.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
    scriptLeaflet.crossOrigin = '';
    scriptLeaflet.onload = () => {
      const scriptDraw = document.createElement('script');
      scriptDraw.src = 'https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js';
      scriptDraw.onload = setupLeaflet;
      document.body.appendChild(scriptDraw);
    };
    document.body.appendChild(scriptLeaflet);
  }

  function setupLeaflet(){
    map = L.map('map').setView([-37.8136, 144.9631], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: { marker:false, circle:false, circlemarker:false, rectangle:false, polyline:false, polygon:true }
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, function (e) {
      if (drawnLayer) map.removeLayer(drawnLayer);
      drawnLayer = e.layer; drawnItems.addLayer(drawnLayer);
    });
    map.on(L.Draw.Event.EDITED, function () { /* layer already updated */ });

    // Load existing polygon
    const saved = localStorage.getItem(STORAGE_KEY_POLY);
    if (saved) {
      try {
        const gj = JSON.parse(saved);
        const layer = L.geoJSON(gj);
        layer.addTo(drawnItems);
        drawnLayer = layer.getLayers()[0];
        map.fitBounds(layer.getBounds(), { padding:[20,20] });
      } catch {}
    }
  }

  function savePolygon(){
    if (!drawnLayer) { toast('No polygon'); return; }
    const gj = drawnLayer.toGeoJSON();
    localStorage.setItem(STORAGE_KEY_POLY, JSON.stringify(gj));
    toast('Service area saved');
  }
  function resetPolygon(){
    localStorage.removeItem(STORAGE_KEY_POLY);
    if (map && drawnLayer) { map.removeLayer(drawnLayer); drawnLayer = null; }
    toast('Service area reset');
  }

  // Hook map init when navigating to Service Area
  const observer = new MutationObserver(() => {
    const sec = document.getElementById('screen-service-area');
    if (sec && !sec.classList.contains('hidden')) initMap();
  });
  observer.observe(document.body, { attributes:true, childList:true, subtree:true });

  // Initialize app
  loadState();
  refreshUI();
  goTab('dashboard');

  // Wire modal actions
  window.saveTip = function() {
    const amount = document.querySelector('#modal-tip input[type="number"]').value;
    const method = document.querySelector('#modal-tip select').value;
    const notes = document.querySelector('#modal-tip input[placeholder="Optional"]').value;
    const bookingId = 'RMM-1042'; // Current booking
    
    if (!amount || amount <= 0) {
      toast('Please enter a valid amount');
      return;
    }
    
    addTip(bookingId, amount, method, notes);
    closeModal('modal-tip');
    
    // Clear form
    document.querySelector('#modal-tip input[type="number"]').value = '';
    document.querySelector('#modal-tip select').value = 'cash';
    document.querySelector('#modal-tip input[placeholder="Optional"]').value = '';
  };

  window.saveExpense = function() {
    const amount = document.querySelector('#modal-expense input[type="number"]').value;
    const type = document.querySelector('#modal-expense select').value;
    const receipt = document.querySelector('#modal-expense input[placeholder="https://..."]').value;
    const notes = document.querySelector('#modal-expense input[placeholder="Optional"]').value;
    
    if (!amount || amount <= 0) {
      toast('Please enter a valid amount');
      return;
    }
    
    addExpense(amount, type, receipt, notes);
    closeModal('modal-expense');
    
    // Clear form
    document.querySelector('#modal-expense input[type="number"]').value = '';
    document.querySelector('#modal-expense select').value = 'parking';
    document.querySelector('#modal-expense input[placeholder="https://..."]').value = '';
    document.querySelector('#modal-expense input[placeholder="Optional"]').value = '';
  };

  window.markCompleted = function() {
    markBookingCompleted('RMM-1042');
  };

  window.markCancelled = function() {
    const notes = document.querySelector('#screen-booking-detail textarea').value;
    markBookingCancelled('RMM-1042', notes);
  };
  </script>
</body>
</html>


