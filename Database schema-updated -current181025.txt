-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.admin_activity_log (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  action character varying NOT NULL,
  table_name character varying NOT NULL,
  record_id character varying,
  old_values jsonb,
  new_values jsonb,
  ip_address inet,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT admin_activity_log_pkey PRIMARY KEY (id)
);
CREATE TABLE public.admin_sessions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  ip_address inet,
  user_agent text,
  created_at timestamp without time zone DEFAULT now(),
  expires_at timestamp without time zone,
  CONSTRAINT admin_sessions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.admin_users (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  email character varying NOT NULL UNIQUE,
  password character varying NOT NULL,
  first_name character varying NOT NULL,
  last_name character varying NOT NULL,
  role character varying NOT NULL DEFAULT 'admin'::character varying CHECK (role::text = ANY (ARRAY['super_admin'::character varying, 'admin'::character varying, 'therapist'::character varying]::text[])),
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  last_login timestamp with time zone,
  CONSTRAINT admin_users_pkey PRIMARY KEY (id)
);
CREATE TABLE public.booking_revisions (
  id bigint NOT NULL DEFAULT nextval('booking_revisions_id_seq'::regclass),
  booking_id character varying NOT NULL,
  revision_number integer NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  modified_by character varying,
  change_reason text,
  snapshot jsonb NOT NULL,
  changes jsonb,
  CONSTRAINT booking_revisions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.booking_status_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  booking_id uuid,
  status character varying NOT NULL,
  changed_at timestamp without time zone DEFAULT now(),
  changed_by uuid,
  notes text,
  CONSTRAINT booking_status_history_pkey PRIMARY KEY (id),
  CONSTRAINT booking_status_history_booking_id_fkey FOREIGN KEY (booking_id) REFERENCES public.bookings(id)
);
CREATE TABLE public.bookings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  customer_id uuid,
  therapist_id uuid,
  alternate_therapist_id uuid,
  booking_time timestamp without time zone NOT NULL,
  status character varying NOT NULL CHECK (status::text = ANY (ARRAY['requested'::character varying::text, 'pending'::character varying::text, 'confirmed'::character varying::text, 'completed'::character varying::text, 'cancelled'::character varying::text, 'declined'::character varying::text, 'timeout_reassigned'::character varying::text, 'seeking_alternate'::character varying::text, 'archived'::character varying::text])),
  payment_status character varying NOT NULL CHECK (payment_status::text = ANY (ARRAY['pending'::character varying, 'paid'::character varying, 'refunded'::character varying, 'failed'::character varying, 'authorized'::character varying, 'captured'::character varying, 'cancelled'::character varying]::text[])),
  price numeric,
  therapist_fee numeric,
  address character varying,
  notes text,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  service_id uuid,
  latitude double precision,
  longitude double precision,
  booker_name text,
  booking_type USER-DEFINED,
  business_name text,
  duration_minutes integer,
  gender_preference text,
  fallback_option text,
  parking text,
  customer_email text,
  customer_phone text,
  room_number text,
  booking_id text,
  customer_code text,
  first_name character varying,
  last_name character varying,
  therapist_response_time timestamp with time zone,
  responding_therapist_id uuid,
  payment_intent_id text,
  completed_at timestamp with time zone,
  completed_by text,
  payment_method character varying DEFAULT 'card'::character varying CHECK (payment_method::text = ANY (ARRAY['card'::character varying, 'invoice'::character varying, 'bank_transfer'::character varying]::text[])),
  discount_amount numeric DEFAULT 0,
  tax_rate_amount numeric DEFAULT 0,
  net_price numeric,
  discount_code character varying,
  gift_card_code character varying,
  gift_card_amount numeric DEFAULT 0,
  service_acknowledgement boolean NOT NULL DEFAULT true,
  terms_acceptance boolean NOT NULL DEFAULT true,
  is_split_booking boolean DEFAULT false,
  parent_quote_id character varying,
  quote_day_number integer,
  payment-notes text,
  revision_number integer DEFAULT 0,
  last_modified_by character varying,
  last_modified_at timestamp with time zone,
  client_update_status character varying DEFAULT NULL::character varying,
  CONSTRAINT bookings_pkey PRIMARY KEY (id),
  CONSTRAINT fk_responding_therapist FOREIGN KEY (responding_therapist_id) REFERENCES public.therapist_profiles(id),
  CONSTRAINT bookings_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT bookings_therapist_id_fkey FOREIGN KEY (therapist_id) REFERENCES public.therapist_profiles(id),
  CONSTRAINT bookings_alternate_therapist_id_fkey FOREIGN KEY (alternate_therapist_id) REFERENCES public.therapist_profiles(id),
  CONSTRAINT bookings_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services(id)
);
CREATE TABLE public.customers (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  first_name character varying NOT NULL,
  last_name character varying NOT NULL,
  email character varying NOT NULL UNIQUE,
  phone character varying,
  address character varying,
  notes text,
  created_at timestamp without time zone DEFAULT now(),
  customer_code text UNIQUE,
  is_guest boolean DEFAULT false,
  CONSTRAINT customers_pkey PRIMARY KEY (id)
);
CREATE TABLE public.discount_code_usage (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  discount_code_id uuid NOT NULL,
  booking_id uuid NOT NULL,
  customer_email character varying,
  discount_applied numeric NOT NULL,
  used_at timestamp without time zone DEFAULT now(),
  CONSTRAINT discount_code_usage_pkey PRIMARY KEY (id),
  CONSTRAINT discount_code_usage_discount_code_id_fkey FOREIGN KEY (discount_code_id) REFERENCES public.discount_codes(id),
  CONSTRAINT discount_code_usage_booking_id_fkey FOREIGN KEY (booking_id) REFERENCES public.bookings(id)
);
CREATE TABLE public.discount_codes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  code character varying NOT NULL UNIQUE,
  description text,
  discount_type character varying NOT NULL CHECK (discount_type::text = ANY (ARRAY['fixed_amount'::character varying, 'percentage'::character varying]::text[])),
  discount_value numeric NOT NULL,
  minimum_order_amount numeric DEFAULT 0,
  maximum_discount_amount numeric,
  usage_limit integer,
  usage_count integer DEFAULT 0,
  valid_from timestamp without time zone DEFAULT now(),
  valid_until timestamp without time zone,
  is_active boolean DEFAULT true,
  created_by uuid,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  expiry_date date,
  CONSTRAINT discount_codes_pkey PRIMARY KEY (id),
  CONSTRAINT discount_codes_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.admin_users(id)
);
CREATE TABLE public.duration_pricing (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  duration_minutes integer NOT NULL UNIQUE,
  uplift_percentage numeric NOT NULL,
  is_active boolean DEFAULT true,
  sort_order integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT duration_pricing_pkey PRIMARY KEY (id)
);
CREATE TABLE public.gift_card_transactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  gift_card_id uuid NOT NULL,
  booking_id uuid,
  transaction_type character varying NOT NULL CHECK (transaction_type::text = ANY (ARRAY['purchase'::character varying, 'redemption'::character varying, 'refund'::character varying, 'expiry'::character varying]::text[])),
  amount numeric NOT NULL,
  balance_before numeric NOT NULL,
  balance_after numeric NOT NULL,
  notes text,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT gift_card_transactions_pkey PRIMARY KEY (id),
  CONSTRAINT gift_card_transactions_booking_id_fkey FOREIGN KEY (booking_id) REFERENCES public.bookings(id),
  CONSTRAINT gift_card_transactions_gift_card_id_fkey FOREIGN KEY (gift_card_id) REFERENCES public.gift_cards(id)
);
CREATE TABLE public.gift_cards (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  code character varying NOT NULL UNIQUE,
  initial_balance numeric NOT NULL,
  current_balance numeric NOT NULL,
  purchaser_name character varying,
  purchaser_email character varying,
  recipient_name character varying,
  recipient_email character varying,
  message text,
  expires_at timestamp without time zone,
  is_active boolean DEFAULT true,
  created_by uuid,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  payment_status character varying DEFAULT 'pending'::character varying CHECK (payment_status::text = ANY (ARRAY['pending'::character varying, 'completed'::character varying, 'failed'::character varying]::text[])),
  payment_intent_id character varying,
  stripe_customer_id character varying,
  payment_method character varying,
  transaction_fee numeric,
  payment_date timestamp without time zone,
  card_holder_name character varying,
  card_holder_email character varying,
  card_holder_phone character varying,
  expiry_date date,
  CONSTRAINT gift_cards_pkey PRIMARY KEY (id),
  CONSTRAINT gift_cards_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.admin_users(id)
);
CREATE TABLE public.notifications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  message text NOT NULL,
  is_read boolean DEFAULT false,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT notifications_pkey PRIMARY KEY (id)
);
CREATE TABLE public.payment_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  stripe_event_id text UNIQUE,
  type text,
  payload jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT payment_events_pkey PRIMARY KEY (id)
);
CREATE TABLE public.payments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  booking_id uuid,
  stripe_payment_intent_id text UNIQUE,
  stripe_payment_method text,
  amount_total numeric,
  amount_captured numeric,
  amount_refunded numeric DEFAULT 0,
  currency text,
  status text,
  receipt_url text,
  customer_email text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT payments_pkey PRIMARY KEY (id),
  CONSTRAINT payments_booking_id_fkey FOREIGN KEY (booking_id) REFERENCES public.bookings(id)
);
CREATE TABLE public.quote_dates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  quote_id character varying NOT NULL,
  event_date date NOT NULL CHECK (event_date >= CURRENT_DATE),
  start_time time without time zone NOT NULL,
  day_number integer NOT NULL CHECK (day_number > 0),
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  finish_time time without time zone,
  duration_minutes integer,
  sessions_count integer,
  service_arrangement text CHECK (service_arrangement = ANY (ARRAY['split'::text, 'multiply'::text])),
  revision_number integer DEFAULT 0,
  last_modified_by character varying,
  last_modified_at timestamp with time zone,
  CONSTRAINT quote_dates_pkey PRIMARY KEY (id),
  CONSTRAINT quote_dates_quote_id_fkey FOREIGN KEY (quote_id) REFERENCES public.quotes(id)
);
CREATE TABLE public.quote_revisions (
  id bigint NOT NULL DEFAULT nextval('quote_revisions_id_seq'::regclass),
  quote_id character varying NOT NULL,
  revision_number integer NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  modified_by character varying,
  change_reason text,
  quote_snapshot jsonb NOT NULL,
  quote_dates_snapshot jsonb NOT NULL,
  quote_changes jsonb,
  quote_dates_changes jsonb,
  operation_type character varying DEFAULT 'full_update'::character varying,
  CONSTRAINT quote_revisions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.quotes (
  id character varying NOT NULL,
  status character varying NOT NULL DEFAULT 'draft'::character varying CHECK (status::text = ANY (ARRAY['draft'::character varying, 'sent'::character varying, 'accepted'::character varying, 'confirmed'::character varying, 'completed'::character varying, 'cancelled'::character varying]::text[])),
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  customer_name character varying,
  customer_email character varying,
  customer_phone character varying,
  event_structure character varying NOT NULL CHECK (event_structure::text = ANY (ARRAY['single_day'::character varying, 'multi_day'::character varying]::text[])),
  number_of_event_days integer,
  event_location character varying,
  event_type character varying,
  total_sessions integer NOT NULL,
  expected_attendees integer,
  preferred_therapists integer,
  company_name character varying,
  business_name character varying,
  corporate_contact_name character varying,
  corporate_contact_email character varying,
  corporate_contact_phone character varying,
  billing_address text,
  po_number character varying,
  setup_requirements text,
  special_requirements text,
  urgency character varying DEFAULT 'flexible'::character varying CHECK (urgency::text = ANY (ARRAY['flexible'::character varying, 'within_week'::character varying, 'within_3_days'::character varying, 'urgent_24h'::character varying]::text[])),
  payment_method character varying DEFAULT 'invoice'::character varying CHECK (payment_method::text = ANY (ARRAY['card'::character varying, 'invoice'::character varying, 'bank_transfer'::character varying]::text[])),
  preferred_time_range text,
  hourly_rate numeric NOT NULL,
  total_amount numeric NOT NULL,
  total_therapist_fees numeric NOT NULL,
  discount_amount numeric DEFAULT 0,
  tax_rate_amount numeric DEFAULT 0,
  final_amount numeric,
  payment_status character varying DEFAULT 'pending'::character varying CHECK (payment_status::text = ANY (ARRAY['pending'::character varying, 'paid'::character varying, 'overdue'::character varying, 'refunded'::character varying]::text[])),
  invoice_number character varying,
  invoice_sent_at timestamp with time zone,
  payment_due_date date,
  paid_amount numeric,
  paid_date date,
  quote_sent_at timestamp with time zone,
  quote_accepted_at timestamp with time zone,
  quote_valid_until date,
  discount_code character varying,
  gift_card_code character varying,
  gift_card_amount numeric DEFAULT 0,
  notes text,
  latitude numeric,
  longitude numeric,
  service_id uuid,
  gst_amount numeric,
  session_duration_minutes numeric,
  sessions_per_day integer,
  therapists_needed integer,
  duration_minutes integer,
  service_arrangement text NOT NULL DEFAULT 'split'::text CHECK (service_arrangement = ANY (ARRAY['split'::text, 'multiply'::text])),
  revision_number integer DEFAULT 0,
  last_modified_by character varying,
  last_modified_at timestamp with time zone,
  CONSTRAINT quotes_pkey PRIMARY KEY (id),
  CONSTRAINT quotes_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services(id),
  CONSTRAINT quotes_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.admin_users(id)
);
CREATE TABLE public.refunds (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  payments_id uuid,
  stripe_refund_id text UNIQUE,
  amount numeric,
  status text,
  reason text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT refunds_pkey PRIMARY KEY (id),
  CONSTRAINT refunds_payments_id_fkey FOREIGN KEY (payments_id) REFERENCES public.payments(id)
);
CREATE TABLE public.services (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  description text,
  image_url text,
  image_alt text,
  is_active boolean DEFAULT true,
  sort_order integer DEFAULT 0,
  service_base_price numeric DEFAULT 90.00,
  minimum_duration numeric DEFAULT '30'::numeric,
  short_description text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  popularity_score integer DEFAULT 0,
  total_bookings integer DEFAULT 0,
  average_rating numeric DEFAULT 0.0,
  quote_only boolean DEFAULT false,
  min_massages integer DEFAULT 1,
  max_massages integer DEFAULT 50,
  requires_quote_above integer,
  quote_description text,
  base_quote_price numeric,
  CONSTRAINT services_pkey PRIMARY KEY (id),
  CONSTRAINT services_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.admin_users(id)
);
CREATE TABLE public.system_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  key character varying NOT NULL UNIQUE,
  value text,
  updated_at timestamp without time zone DEFAULT now(),
  data_type character varying,
  category character varying,
  description text,
  is_sensitive boolean DEFAULT false,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT system_settings_pkey PRIMARY KEY (id)
);
CREATE TABLE public.therapist_availability (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  therapist_id uuid,
  day_of_week integer NOT NULL CHECK (day_of_week >= 0 AND day_of_week <= 6),
  start_time time without time zone NOT NULL,
  end_time time without time zone NOT NULL,
  CONSTRAINT therapist_availability_pkey PRIMARY KEY (id),
  CONSTRAINT therapist_availability_therapist_id_fkey FOREIGN KEY (therapist_id) REFERENCES public.therapist_profiles(id)
);
CREATE TABLE public.therapist_payments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  therapist_id uuid NOT NULL,
  week_start_date date NOT NULL,
  week_end_date date NOT NULL,
  calculated_fees numeric NOT NULL DEFAULT 0,
  booking_count integer DEFAULT 0,
  booking_ids text,
  therapist_invoice_number character varying,
  therapist_invoice_date date,
  therapist_invoice_url text,
  therapist_invoiced_fees numeric,
  therapist_parking_amount numeric DEFAULT 0,
  parking_receipt_url text,
  therapist_total_claimed numeric,
  therapist_notes text,
  submitted_at timestamp with time zone,
  variance_fees numeric DEFAULT 0,
  variance_notes text,
  admin_approved_fees numeric,
  admin_approved_parking numeric,
  admin_total_approved numeric,
  admin_notes text,
  reviewed_by uuid,
  reviewed_at timestamp with time zone,
  paid_amount numeric,
  paid_date date,
  eft_reference character varying,
  payment_notes text,
  processed_by uuid,
  processed_at timestamp with time zone,
  status character varying NOT NULL DEFAULT 'draft'::character varying CHECK (status::text = ANY (ARRAY['draft'::character varying, 'submitted'::character varying, 'under_review'::character varying, 'approved'::character varying, 'paid'::character varying, 'disputed'::character varying, 'rejected'::character varying]::text[])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  updated_by uuid,
  CONSTRAINT therapist_payments_pkey PRIMARY KEY (id),
  CONSTRAINT therapist_payments_therapist_id_fkey FOREIGN KEY (therapist_id) REFERENCES public.therapist_profiles(id),
  CONSTRAINT therapist_payments_reviewed_by_fkey FOREIGN KEY (reviewed_by) REFERENCES auth.users(id),
  CONSTRAINT therapist_payments_processed_by_fkey FOREIGN KEY (processed_by) REFERENCES auth.users(id),
  CONSTRAINT therapist_payments_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id),
  CONSTRAINT therapist_payments_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES auth.users(id)
);
CREATE TABLE public.therapist_profiles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  first_name character varying NOT NULL,
  last_name character varying NOT NULL,
  email character varying NOT NULL,
  phone character varying,
  bio text,
  profile_pic text,
  home_address character varying,
  latitude double precision,
  longitude double precision,
  service_radius_km integer,
  is_active boolean DEFAULT true,
  gender character varying CHECK (gender::text = ANY (ARRAY['male'::character varying, 'female'::character varying, 'other'::character varying, 'prefer_not_to_say'::character varying]::text[])),
  years_experience integer,
  rating numeric DEFAULT 0.00,
  total_reviews integer DEFAULT 0,
  business_abn character varying NOT NULL CHECK (business_abn::text ~ '^\d{11}$'::text OR business_abn::text = ''::text),
  address_verified boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  service_area_polygon jsonb,
  CONSTRAINT therapist_profiles_pkey PRIMARY KEY (id),
  CONSTRAINT therapist_profiles_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.admin_users(id)
);
CREATE TABLE public.therapist_services (
  therapist_id uuid,
  service_id uuid,
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  CONSTRAINT therapist_services_pkey PRIMARY KEY (id),
  CONSTRAINT therapist_services_therapist_id_fkey FOREIGN KEY (therapist_id) REFERENCES public.therapist_profiles(id),
  CONSTRAINT therapist_services_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services(id)
);
CREATE TABLE public.therapist_time_off (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  therapist_id uuid,
  start_date date NOT NULL,
  end_date date NOT NULL,
  start_time time without time zone,
  end_time time without time zone,
  reason text,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT therapist_time_off_pkey PRIMARY KEY (id),
  CONSTRAINT therapist_time_off_therapist_id_fkey FOREIGN KEY (therapist_id) REFERENCES public.therapist_profiles(id)
);
CREATE TABLE public.time_pricing_rules (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  day_of_week integer NOT NULL CHECK (day_of_week >= 0 AND day_of_week <= 6),
  start_time time without time zone NOT NULL,
  end_time time without time zone NOT NULL,
  uplift_percentage numeric NOT NULL,
  label character varying,
  is_active boolean DEFAULT true,
  sort_order integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT time_pricing_rules_pkey PRIMARY KEY (id)
);